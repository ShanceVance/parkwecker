<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ParkWecker – Parkschein-Timer</title>
<meta name="theme-color" content="#0f172a"/>
<meta name="color-scheme" content="dark light">
<style>
/* ======= Design-System (Glas/Neo, Premium) ======= */
:root{
  --bg1:#0f172a; --bg2:#111827;
  --accent1:#7c3aed; --accent2:#06b6d4; --accent3:#22c55e;
  --warn:#f59e0b; --danger:#ef4444;
  --surface:rgba(255,255,255,.06); --surface-strong:rgba(255,255,255,.12);
  --text:#e5e7eb; --muted:#cbd5e1;
  --shadow:0 18px 45px rgba(0,0,0,.45);
  --glass: blur(14px) saturate(120%);
  --r:18px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 80% -10%, rgba(124,58,237,.25), transparent 60%),
    radial-gradient(1000px 700px at -10% 20%, rgba(6,182,212,.22), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  -webkit-tap-highlight-color: transparent;
  overflow-x:hidden;
}

.app{
  min-height:100%;
  display:grid; grid-template-rows:auto 1fr; gap:12px;
  padding:max(10px,env(safe-area-inset-top)) max(10px,env(safe-area-inset-right))
          calc(18px + env(safe-area-inset-bottom)) max(10px,env(safe-area-inset-left));
}

/* Header */
header{display:flex; align-items:center; justify-content:space-between;}
.brand{display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.2px; cursor:pointer}
h1.brand-name{font-size:18px; margin:0}

/* App-Icon (CSS/SVG) */
.pw-icon{
  --size: 30px; --radius: 30%;
  width:var(--size); height:var(--size);
  border-radius:var(--radius);
  position:relative; overflow:hidden; display:grid; place-items:center;
  background:
    radial-gradient(120% 100% at 80% 10%, rgba(255,255,255,.18), transparent 55%),
    linear-gradient(135deg, #1e40af 0%, #06b6d4 100%);
  box-shadow: inset 0 0 10px rgba(255,255,255,.12);
}
.pw-icon::after{content:""; position:absolute; inset:0; border-radius:inherit; box-shadow: inset 0 0 0 1px rgba(255,255,255,.14);}
.pw-symbol{ width:70%; height:70%; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); }

/* Icon buttons */
.icon-btn{
  border:none; background:var(--surface); border:1px solid rgba(255,255,255,.08);
  width:44px; height:44px; border-radius:14px; display:grid; place-items:center;
  box-shadow:var(--shadow); backdrop-filter: var(--glass);
  transition: transform .12s ease, box-shadow .25s ease, background .25s ease;
}
.icon-btn:hover{ transform: translateY(-1px); box-shadow:0 16px 40px rgba(0,0,0,.5); background:var(--surface-strong) }

/* Screens */
.screen{display:none; animation:fade .24s ease-out}
.screen.active{display:block}
@keyframes fade{from{opacity:.0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

/* ===== EIN großer Container mit Trennern ===== */
.card{
  background: var(--surface); border:1px solid rgba(255,255,255,.08);
  border-radius: var(--r); box-shadow: var(--shadow);
  backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
  padding:12px;
}
#screenStart .main-container{ display:block; }
.section{ padding:10px 4px; }
.section h2{margin:0 0 8px; font-size:17px}
.section-divider{height:1px; background:rgba(255,255,255,.14); margin:6px 0;}

/* Buttons */
.btn{
  border:none; border-radius:16px; padding:16px; min-height:60px; font-weight:800;
  color:#fff; background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
  border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow);
  transition: transform .08s ease, filter .25s ease, background .25s ease;
  width:100%;
  display:flex; align-items:center; justify-content:center;
}
.btn:active{transform:scale(.98)}
.btn:hover{filter:brightness(1.05)}
.btn.primary{background:linear-gradient(135deg, var(--accent2), var(--accent1));}
.btn.flat{background:var(--surface); border:1px solid rgba(255,255,255,.08)}
.btn.warn{background:linear-gradient(135deg, var(--warn), #fbbf24); color:#111}
.btn.danger{background:linear-gradient(135deg, var(--danger), #f87171);}
.btn.small{min-height:56px; padding:14px; border-radius:14px}

/* Start-Buttons */
.start-grid{display:grid; grid-template-columns:1fr; gap:10px; margin-top:2px}
@media(min-width:420px){ .start-grid{grid-template-columns:repeat(3,1fr)} }

/* START Button – breit, uppercase, zentriert */
#btnManualStart{
  text-transform:uppercase;
  font-size:18px; font-weight:800; letter-spacing:.4px;
  align-self:stretch;
}

/* ====== Scroll-Picker ====== */
.wheels{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.wheel{
  position:relative; height:160px; border-radius:14px; overflow:hidden;
  background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12);
  box-shadow: inset 0 6px 16px rgba(0,0,0,.25), inset 0 -6px 16px rgba(0,0,0,.25);
}
.wheel .viewport{
  height:100%; overflow-y:auto; scroll-snap-type:y mandatory;
  scrollbar-width:none; -ms-overflow-style:none;
  overscroll-behavior-y: contain;
}
.wheel .viewport::-webkit-scrollbar{display:none}

.item{
  height:48px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; color:var(--muted);
  scroll-snap-align:center;
  transition: transform .12s ease, color .12s ease;
  font-variant-numeric: tabular-nums;
  line-height:1; user-select:none;
}
.item.sel{ color:#fff; transform:scale(1.16); font-weight:800; }

/* Center-Highlight-Linien */
.wheel::before, .wheel::after{
  content:""; position:absolute; left:8px; right:8px; height:0; border-top:1px dashed rgba(255,255,255,.22);
}
.wheel::before{ top: calc(50% - 24px); }
.wheel::after{ top: calc(50% + 24px); }

/* Single wheel (Reminder) */
.wheel.single{ grid-column:1/-1; }

/* Timer ring */
.timer-wrap{display:grid; gap:12px}
.ring{ position:relative; width:100%; max-width:520px; margin:0 auto; aspect-ratio:1/1; display:grid; place-items:center; filter: drop-shadow(0 18px 45px rgba(0,0,0,.45)); }
.ring svg{width:100%; height:100%}
.ring .shadow-glow{ position:absolute; inset: -10% -10% -10% -10%; background: radial-gradient(closest-side, rgba(124,58,237,.25), transparent 70%); z-index:0; filter: blur(20px); }
/* Countdown fest zentriert – auch nach Notifications */
.ring .time{
  position:absolute; width:100%; text-align:center; z-index:2; font-variant-numeric: tabular-nums; letter-spacing:.6px;
  top:50%; left:50%; transform:translate(-50%,-50%);
}
.time .big{font-size:44px; font-weight:800}

/* Photo */
.photo-wrap{
  position:relative; border-radius:18px; overflow:hidden; background:#0b0b0b; aspect-ratio:16/9; display:grid; place-items:center;
  border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); backdrop-filter:var(--glass); margin-top:4px;
}
.photo-wrap img,.photo-wrap video,.photo-wrap canvas{width:100%; height:100%; object-fit:cover}
.tap-overlay{ position:absolute; inset:auto 0 0 0; background:linear-gradient(180deg, transparent, rgba(0,0,0,.55)); color:#fff; padding:8px 12px; font-size:13px; text-align:center; opacity:0; transition:opacity .25s ease; pointer-events:none; z-index:2 }
.photo-wrap:hover .tap-overlay{opacity:1}
.chip{ background:rgba(0,0,0,.5); color:#fff; border:none; border-radius:12px; padding:10px 12px; min-height:44px; min-width:44px; font-size:15px; border:1px solid rgba(255,255,255,.14); backdrop-filter: blur(8px); }

/* Overlay (Prompt / Alarm / End / Settings) */
.overlay{position:fixed; inset:0; background:rgba(10,10,10,.6); display:none; align-items:center; justify-content:center; padding:14px; z-index:20}
.overlay.show{display:flex}
.modal{
  width:100%; max-width:520px; background:var(--surface); border-radius:20px; box-shadow: var(--shadow);
  border:1px solid rgba(255,255,255,.12); padding:14px; text-align:center; backdrop-filter:var(--glass)
}
.modal h3{margin:6px 0 4px}
.modal p{margin:0 0 10px; color:var(--muted)}

/* Settings – Alarmton Auswahl */
.settings-group{ text-align:left; display:grid; gap:10px; margin:10px 0 }
.alarm-row{ display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; }
.badge{ font-size:12px; color:#111; background:#fff; border-radius:999px; padding:4px 8px; display:none; }
.badge.show{ display:inline-block; }

/* History */
.history{display:grid; gap:8px}
.row{
  display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:8px;
  border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); backdrop-filter:var(--glass)
}
.thumb{width:56px; height:40px; object-fit:cover; border-radius:8px; background:#111; border:1px solid rgba(255,255,255,.1)}
.meta{font-size:13px; color:#e5e7eb80}
.pill{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); font-size:12px; color:#e5e7eb9c}

/* Toast */
#toast{position:fixed; top:14px; left:50%; transform:translateX(-50%); display:none; padding:8px 12px; border-radius:999px; background:rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.15); z-index:50}

/* ======= Responsive Tweaks ======= */
@media (max-height: 700px){
  .wheel{height:140px}
  .item{font-size:19px}
  .btn.small{min-height:52px}
  .start-grid{gap:8px}
}
@media (max-height: 600px){
  .wheel{height:128px}
  .item{font-size:18px}
}
@media (max-width: 360px){
  .item{font-size:18px}
  .btn{min-height:56px}
  .wheels{gap:8px}
}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Header -->
  <header>
    <div class="brand" id="brandHome" title="Zur Startseite">
      <div class="pw-icon" aria-hidden="true">
        <svg viewBox="0 0 100 100" class="pw-symbol">
          <circle cx="50" cy="50" r="28" fill="none" stroke="white" stroke-width="8" stroke-linecap="round"/>
          <line x1="50" y1="50" x2="50" y2="33" stroke="white" stroke-width="6" stroke-linecap="round"/>
          <line x1="50" y1="50" x2="64" y2="57" stroke="white" stroke-width="6" stroke-linecap="round"/>
          <circle cx="50" cy="50" r="3.5" fill="white"/>
          <g transform="translate(62,62)">
            <rect x="-12" y="-12" width="24" height="24" rx="6" fill="white"/>
            <path d="M -5 8 V -8 H 3.5
                     C 7 -8 10 -5.5 10 -2.2
                     C 10 1.0 7 3.5 3.5 3.5 H -1.5 V 8 Z
                     M -1.5 0 H 3.2
                     C 4.9 0 6.2 -1.2 6.2 -2.2
                     C 6.2 -3.3 4.9 -4.5 3.2 -4.5 H -1.5 V 0 Z"
                  fill="#1247C6"/>
          </g>
        </svg>
      </div>
      <h1 class="brand-name">ParkWecker</h1>
    </div>
    <div style="display:flex; gap:8px">
      <button class="icon-btn" id="btnTimer" title="Timer" aria-label="Timer">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="13" r="8"/><path d="M12 9v4l3 2"/><path d="M9 2h6"/><path d="M19 4l-1.5 1.5"/>
        </svg>
      </button>
      <button class="icon-btn" id="btnHistory" title="Verlauf" aria-label="Verlauf">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 3-6.7"/><path d="M3 3v6h6"/><path d="M12 7v5l3 3"/>
        </svg>
      </button>
      <button class="icon-btn" id="btnSettings" title="Einstellungen" aria-label="Einstellungen">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.77 19l.06-.06a1.65 1.65 0 0 0 .33-1.82A1.65 1.65 0 0 0 3.65 15H3a2 2 0 1 1 0-4h.65A1.65 1.65 0 0 0 4.83 9 1.65 1.65 0 0 0 4.5 7.18L4.44 7.1A2 2 0 1 1 7.27 4.27l.06.06A1.65 1.65 0 0 0 9.15 4h.09A1.65 1.65 0 0 0 10.75 3V3a2 2 0 1 1 4 0v.06a1.65 1.65 0 0 0 1.51 1 1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 21 7.27l-.06.06A1.65 1.65 0 0 0 20 9.15v.09A1.65 1.65 0 0 0 21 10.75h.06A2 2 0 1 1 21 14h-.06a1.65 1.65 0 0 0-1.54 1z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- START – EINE große Box mit 3 Sektionen -->
  <section id="screenStart" class="screen active">
    <div class="card main-container">
      <!-- Sektion 1 -->
      <div class="section">
        <h2>Zeit wählen</h2>
        <div class="start-grid">
          <button class="btn primary start" data-min="15">15 Min</button>
          <button class="btn primary start" data-min="30">30 Min</button>
          <button class="btn primary start" data-min="60">1 Stunde</button>
        </div>
      </div>
      <div class="section-divider" aria-hidden="true"></div>

      <!-- Sektion 2 -->
      <div class="section">
        <h2>Timer manuell einstellen</h2>
        <div class="wheels">
          <div class="wheel" id="wheelH"><div class="viewport" id="vpH"></div></div>
          <div class="wheel" id="wheelM"><div class="viewport" id="vpM"></div></div>
        </div>
        <div style="height:8px"></div>
        <button class="btn primary small" id="btnManualStart">START</button>
      </div>
      <div class="section-divider" aria-hidden="true"></div>

      <!-- Sektion 3 -->
      <div class="section">
        <h2>Erinnerung vor Timer-Ende</h2>
        <div class="wheel single" id="wheelR"><div class="viewport" id="vpR"></div></div>
        <p style="margin:8px 0 0; color:var(--muted); font-size:13px">Die Erinnerung wird automatisch vor Ablauf ausgelöst. Deine Auswahl wird gespeichert.</p>
      </div>
    </div>
  </section>

  <!-- TIMER -->
  <section id="screenTimer" class="screen">
    <div class="card timer-wrap">
      <div class="ring normalColor" id="ring">
        <div class="shadow-glow"></div>
        <svg viewBox="0 0 120 120">
          <defs><linearGradient id="gradStroke" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--accent2)"/><stop offset="100%" stop-color="var(--accent1)"/></linearGradient></defs>
          <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.1)" stroke-width="8" fill="none"/>
          <circle id="progress" cx="60" cy="60" r="52" stroke="url(#gradStroke)" stroke-width="8" stroke-linecap="round" stroke-dasharray="326.7256" stroke-dashoffset="0" fill="none" transform="rotate(-90 60 60)"/>
        </svg>
        <div class="time" id="timeBox"><div class="big" id="countdown">00:00:00</div></div>
      </div>

      <!-- Foto -->
      <div class="photo-wrap" id="photoWrap" aria-label="Parkplatz-Foto" style="display:none">
        <img id="photo" alt="Parkplatz-Foto"/>
        <video id="video" playsinline autoplay muted style="display:none"></video>
        <canvas id="canvas" style="display:none"></canvas>
        <div class="tap-overlay">Tippen, um ein neues Foto zu machen</div>
        <div style="position:absolute; bottom:10px; right:10px; display:flex; gap:8px;">
          <button id="btnTakePhoto" class="chip"><span id="camLabel">Kamera</span></button>
          <button id="btnRetake" class="chip" style="display:none">Neu</button>
          <button id="btnSkipPhoto" class="chip" style="display:none">Weiter ohne Foto</button>
          <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
        </div>
      </div>

      <!-- Standort & Share -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">
        <button class="btn flat small" id="btnShowMap" style="display:none">Standort anzeigen</button>
        <button class="btn flat small" id="btnShare" style="display:none">Teilen</button>
      </div>

      <!-- Quick actions -->
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px">
        <button class="btn warn small" id="btnPlus30">+ 30 min</button>
        <button class="btn warn small" id="btnPlus60">+ 1 h</button>
        <button class="btn danger small" id="btnStop">Stoppen</button>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="screenHistory" class="screen">
    <div class="card">
      <h3 style="margin:6px 0 10px">Verlauf (letzte 3)</h3>
      <div class="history" id="historyList"></div>
      <div class="pill" id="historyNone">Noch keine Einträge.</div>
    </div>
  </section>

  <!-- PROMPTS -->
  <div class="overlay" id="promptOverlay">
    <div class="modal" id="promptCard">
      <h3 id="promptTitle">Standort speichern?</h3>
      <p id="promptText">So findest du den Platz direkt auf der Karte.</p>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn primary small" id="promptYes">Ja</button>
        <button class="btn flat small" id="promptNo">Nein</button>
      </div>
    </div>
  </div>

  <!-- END OVERLAY -->
  <div class="overlay" id="endOverlay">
    <div class="modal">
      <h3>Timer beendet</h3>
      <p>Bitte Parkschein verlängern oder Platz wechseln.</p>
      <div id="endPhotoWrap" class="photo-wrap" style="margin-top:8px; display:none"><img id="endPhoto" alt="Foto"/></div>
      <div style="margin-top:10px" id="endMapWrap"></div>
      <div style="height:8px"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn danger" id="btnStopAlarm">Alarm stoppen</button>
        <button class="btn flat" id="btnEndOk">OK</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="overlay" id="settingsOverlay">
    <div class="modal">
      <h3>Einstellungen</h3>
      <div class="settings-group">
        <div style="font-weight:700; margin-bottom:2px">Alarmton wählen</div>
        <div class="alarm-row"><div>Glocken</div><button class="btn flat small alarm-select" data-type="1">Auswählen</button><button class="btn primary small alarm-test" data-type="1">Test</button></div>
        <div class="alarm-row"><div>Modern</div><button class="btn flat small alarm-select" data-type="2">Auswählen</button><button class="btn primary small alarm-test" data-type="2">Test</button></div>
        <div class="alarm-row"><div>Melodie</div><button class="btn flat small alarm-select" data-type="3">Auswählen</button><button class="btn primary small alarm-test" data-type="3">Test</button></div>
        <div style="font-size:12px; color:var(--muted)">Deine Auswahl wird gespeichert und für den nächsten Timer verwendet.</div>
      </div>
      <div class="settings-group">
        <label style="display:flex; align-items:center; justify-content:space-between; gap:10px">Ton <input id="togSound" type="checkbox" checked></label>
        <label style="display:flex; align-items:center; justify-content:space-between; gap:10px">Vibration <input id="togVib" type="checkbox" checked></label>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn flat" id="btnNotif">System-Benachrichtigungen erlauben</button>
        <button class="btn primary" id="btnCloseSettings">Schließen</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="card" id="toast">OK</div>
</div>

<script>
(function(){
'use strict';

/* ===== Utils & State ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const NOW=()=>Date.now();

/* Keys (bump for cache-bust) */
const K_STATE='pw_state_v10';
const K_HIST ='pw_hist_v10';
const K_CFG  ='pw_cfg_v10';
const K_REM  ='pw_reminder_v2';
const K_ALARM='pw_alarm_v2';

/* Config / State */
let cfg = loadCfg();
let st  = loadState();
let tick=null, audioCtxUnlocked=false;
let reminderMin = loadReminder();
let reminderFired=false;
let stream=null; // Camera stream
let alarmLoopInt=null;
let photoWaitActive=false;
let flowLock=false;

/* ===== Storage ===== */
function defState(){ return {running:false,start:0,end:0,photo:null,loc:null}; }
function loadState(){ try{ return JSON.parse(localStorage.getItem(K_STATE)) || defState(); }catch(e){return defState();} }
function saveState(){ localStorage.setItem(K_STATE, JSON.stringify(st)); }
function loadCfg(){ try{ return Object.assign({sound:true,vibrate:true, alarmType:2}, JSON.parse(localStorage.getItem(K_CFG)||'{}')); }catch(e){return {sound:true,vibrate:true, alarmType:2}} }
function saveCfg(){ localStorage.setItem(K_CFG, JSON.stringify(cfg)); }
function loadHist(){ try{ return JSON.parse(localStorage.getItem(K_HIST)) || []; }catch(e){return []} }
function saveHist(a){ localStorage.setItem(K_HIST, JSON.stringify(a.slice(0,3))); }
function loadReminder(){ try{ const v=JSON.parse(localStorage.getItem(K_REM)||'5'); return [0,5,10,15,20,25].includes(v)?v:5; }catch(e){return 5} }
function saveReminder(v){ localStorage.setItem(K_REM, JSON.stringify(v)); }

/* ===== UI helpers ===== */
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>{ t.style.display='none'; }, 1300); }
function vib(p){ if(!cfg.vibrate) return; if(navigator.vibrate) navigator.vibrate(p); }
function unlockAudio(){ if(audioCtxUnlocked) return; try{ const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; const ctx=new AC(); const b=ctx.createBuffer(1,1,22050), s=ctx.createBufferSource(); s.buffer=b; s.connect(ctx.destination); s.start(0); setTimeout(()=>{ctx.close(); audioCtxUnlocked=true;},50);}catch(e){} }
function blip(freq=880, dur=140, type='sine'){ if(!cfg.sound) return; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; const ctx=new AC();
  const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=.0001;
  o.connect(g).connect(ctx.destination); o.start();
  g.gain.exponentialRampToValueAtTime(.2, ctx.currentTime+0.02);
  o.stop(ctx.currentTime+dur/1000);
  setTimeout(()=>ctx.close(), dur+80);
}

/* Non-blocking notify (keine Alerts mehr) */
function notifyNonBlocking(text){
  // Nur Toast – keine blocking Alerts. System-Notifications nur auf expliziten Button.
  toast(text);
}

/* App Badge */
async function setBadge(num){ try{ if('setAppBadge' in navigator) await navigator.setAppBadge(num); }catch{} }
async function clearBadge(){ try{ if('clearAppBadge'in navigator) await navigator.clearAppBadge(); }catch{} }

/* ===== Timer Ring ===== */
const circumference = 2 * Math.PI * 52;
const $progress = $('#progress');
function setRingProgress(percent){
  const offset = circumference * (1 - percent);
  $progress.style.strokeDasharray = String(circumference);
  $progress.style.strokeDashoffset = String(offset);
}

/* ===== WebAudio – Alarmtöne ===== */
function createCtx(){ const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; return new AC(); }
function tone(ctx, {freq=440, start=0, dur=0.4, type='sine', attack=0.02, release=0.15, gain=0.15}){
  const o=ctx.createOscillator(); o.type=type; o.frequency.value=freq;
  const g=ctx.createGain(); g.gain.value=0.0001;
  o.connect(g).connect(ctx.destination);
  const t0=ctx.currentTime+start;
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0+attack);
  g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
  o.start(t0); o.stop(t0+dur+release);
}
function playBell(preview=false){
  if(!cfg.sound) return;
  const ctx=createCtx(); if(!ctx) return;
  const len=preview?1.6:2.6;
  [{f:261,t:0.0},{f:330,t:0.8},{f:392,t:1.6}]
    .forEach(s=>tone(ctx,{freq:s.f, start:s.t, dur:0.8, type:'sine', attack:0.04, release:0.3, gain:0.20}));
  setTimeout(()=>ctx.close(), (len*1000)+150);
}
function playModern(preview=false){
  if(!cfg.sound) return; const ctx=createCtx(); if(!ctx) return;
  const reps=preview?2:3; for(let i=0;i<reps;i++){ tone(ctx,{freq:800, start:i*1.3, dur:1.0, type:'sine', attack:0.02, release:0.12, gain:0.22}); }
  setTimeout(()=>ctx.close(), (reps*1.3*1000)+200);
}
function playMelody(preview=false){
  if(!cfg.sound) return; const ctx=createCtx(); if(!ctx) return;
  [261,294,330,392].forEach((f,i)=>tone(ctx,{freq:f, start:i*0.42, dur:0.4, type:'triangle', attack:0.02, release:0.1, gain:0.18}));
  setTimeout(()=>ctx.close(), (4*0.42*1000)+200);
}
function playSelected(preview=false){
  switch(cfg.alarmType){
    case 1: playBell(preview); break;
    case 2: playModern(preview); break;
    case 3: playMelody(preview); break;
    default: playModern(preview);
  }
}
let alarmLoopInt=null;
function startAlarmLoop(){
  stopAlarmLoop();
  playSelected(false);
  const dur = (cfg.alarmType===1)?2600 : (cfg.alarmType===2)?3900 : 1800;
  alarmLoopInt = setInterval(()=>playSelected(false), dur);
}
function stopAlarmLoop(){
  if(alarmLoopInt){ clearInterval(alarmLoopInt); alarmLoopInt=null; }
}

/* ===== Camera & Photo flow ===== */
async function startCam(){
  stopCam();
  const secure = window.isSecureContext;
  if(!secure || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    $('#camLabel').textContent='Foto hochladen';
    $('#fileInput').click(); return;
  }
  try{
    $('#camLabel').innerHTML='<svg viewBox="0 0 50 50" style="width:18px;height:18px;animation:rspin .8s linear infinite"><circle cx="25" cy="25" r="20" stroke="rgba(255,255,255,.3)" stroke-width="6" fill="none"/><path d="M45 25a20 20 0 0 1-20 20" stroke="#fff" stroke-width="6" fill="none" stroke-linecap="round"/></svg> Öffne…';
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    const v=$('#video'); v.srcObject=stream; v.style.display='block'; $('#photo').style.display='none';
    await new Promise(r=>{
      if(v.readyState>=2) return r();
      v.onloadedmetadata=()=>r();
    });
    $('#camLabel').textContent='Aufnehmen';
    $('#btnSkipPhoto').style.display='inline-block';
  }catch(e){
    $('#camLabel').textContent='Foto hochladen';
    $('#fileInput').click();
  }
}
function stopCam(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  $('#video').style.display='none';
  $('#btnSkipPhoto').style.display='none';
}
async function capturePhoto(){
  const v=$('#video');
  if(!v.srcObject){ await startCam(); return; }
  // Warten bis Frames wirklich anliegen
  if(v.videoWidth===0 || v.videoHeight===0){
    await new Promise(r=>{
      const to=setTimeout(r, 400);
      v.onloadeddata=()=>{ clearTimeout(to); r(); };
    });
  }
  $('#camLabel').innerHTML='<svg viewBox="0 0 50 50" style="width:18px;height:18px;animation:rspin .8s linear infinite"><circle cx="25" cy="25" r="20" stroke="rgba(255,255,255,.3)" stroke-width="6" fill="none"/><path d="M45 25a20 20 0 0 1-20 20" stroke="#fff" stroke-width="6" fill="none" stroke-linecap="round"/></svg> Speichere…';
  await new Promise(r=>requestAnimationFrame(r));
  const c=$('#canvas'), ctx=c.getContext('2d'); const w=v.videoWidth||1280, h=v.videoHeight||720; c.width=w;c.height=h; ctx.drawImage(v,0,0,w,h);
  try{
    const data=c.toDataURL('image/jpeg',0.9);
    st.photo=data; saveState(); renderPhoto(); toast('Foto gespeichert'); vib(30);
  }catch(e){ toast('Konnte Foto nicht speichern'); }
  finally{
    $('#camLabel').textContent='Aufnehmen';
    stopCam();
  }
  if(photoWaitActive) document.dispatchEvent(new CustomEvent('photo-decision',{detail:{status:'saved'}}));
}
$('#fileInput').addEventListener('change', (e)=>{
  const file=e.target.files && e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{ st.photo=String(reader.result); saveState(); renderPhoto(); toast('Foto gespeichert'); vib(30);
    if(photoWaitActive) document.dispatchEvent(new CustomEvent('photo-decision',{detail:{status:'saved'}}));
  };
  reader.readAsDataURL(file);
});
function renderPhoto(){
  const img=$('#photo');
  if(st.photo){ img.src=st.photo; $('#photoWrap').style.display='block'; $('#btnRetake').style.display='inline-block'; }
  else { $('#photoWrap').style.display='none'; $('#btnRetake').style.display='none'; }
}

/* ===== Location ===== */
async function askGeo(){
  if(!('geolocation' in navigator)){ toast('GPS nicht verfügbar'); return false; }
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:8000, maximumAge:60000}));
    st.loc={lat:pos.coords.latitude, lon:pos.coords.longitude, acc:pos.coords.accuracy}; saveState();
    toast('Standort gespeichert'); vib(20); return true;
  }catch(e){ toast('GPS abgelehnt'); return false; }
}
function showMapBtn(){ if(st.loc){ $('#btnShowMap').style.display='inline-block'; $('#btnShare').style.display='inline-block'; } else { $('#btnShowMap').style.display='none'; $('#btnShare').style.display='none'; } }

/* ===== Prompts ===== */
function showPrompt(title, text){
  if(photoWaitActive) return Promise.resolve(false);
  $('#promptTitle').textContent=title; $('#promptText').textContent=text; $('#promptOverlay').classList.add('show');
  return new Promise(res=>{
    const onYes=()=>{ cleanup(); res(true); };
    const onNo =()=>{ cleanup(); res(false); };
    $('#promptYes').onclick=onYes; $('#promptNo').onclick=onNo;
    function cleanup(){ $('#promptYes').onclick=null; $('#promptNo').onclick=null; $('#promptOverlay').classList.remove('show'); }
  });
}

/* ► Warte STRIKT auf Foto-Entscheidung */
function waitForPhotoDecision(){
  photoWaitActive = true;
  return new Promise(res=>{
    const onDecision = (e)=>{ cleanup(); res(e.detail?.status || 'skipped'); };
    const onSkip = ()=>{ stopCam(); st.photo=null; saveState(); renderPhoto(); cleanup(); res('skipped'); };
    function cleanup(){
      photoWaitActive = false;
      document.removeEventListener('photo-decision', onDecision);
      $('#btnSkipPhoto').onclick=null;
      $('#btnSkipPhoto').style.display='none';
    }
    document.addEventListener('photo-decision', onDecision, {once:true});
    $('#btnSkipPhoto').onclick=onSkip;
  });
}

/* ===== Timer Core ===== */
function startTimer(minutes){
  const now=NOW(); st.start=now; st.end=now+minutes*60000; st.running=true; reminderFired=false;
  saveState(); runTick(); renderTimerUI(); unlockAudio(); toast('Timer gestartet'); blip(1200,120,'sine'); vib(40);
}
function stopTimer(record=true){
  clearInterval(tick); tick=null;
  stopAlarmLoop();
  const ended=NOW();
  if(record && st.start && st.end){
    const hist=loadHist(); hist.unshift({start:st.start, end:ended, plannedEnd:st.end, photo:st.photo, loc:st.loc}); saveHist(hist);
  }
  st=defState(); saveState(); clearBadge(); renderTimerUI(); nav('#screenStart');
}
function extendTimer(min){ if(!st.running) return; st.end+=min*60000; saveState(); updateCountdown(); toast('Verlängert'); vib(20); }
function runTick(){ if(tick) clearInterval(tick); tick=setInterval(updateCountdown,1000); updateCountdown(); }
function fmt(ms){ if(ms<0)ms=0; const s=Math.floor(ms/1000); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`;}
function updateCountdown(){
  if(!st.running) return;
  const total=st.end-st.start, left=st.end-NOW(), leftPos=Math.max(left,0), pct=Math.min(Math.max(leftPos/Math.max(total,1),0),1);
  setRingProgress(pct); $('#countdown').textContent=fmt(left);
  setBadge(Math.ceil(leftPos/60000));

  const remMs = Math.max(0, reminderMin) * 60000;
  if(remMs>0 && !reminderFired && left>0 && left<=remMs){
    reminderFired = true;
    playSelected(true);           // gleiche Melodie wie Ende
    vib([200,100,200,100,200]);
    notifyNonBlocking(`Noch ${reminderMin} Minuten.`);
  }

  if(left<=0){ onTimerEnd(); }
}

/* ===== End handling ===== */
function onTimerEnd(){
  if(!st.running) return;
  // Kein blockierendes Popup – direkt Sound starten
  startAlarmLoop();
  vib([400,150,400,150,400,150,600]);

  clearInterval(tick); tick=null;
  if(st.photo){ $('#endPhoto').src=st.photo; $('#endPhotoWrap').style.display='block'; } else { $('#endPhotoWrap').style.display='none'; }
  const endMap=$('#endMapWrap'); endMap.innerHTML='';
  if(st.loc){ const a=document.createElement('a'); a.href=`https://maps.google.com/?q=${st.loc.lat},${st.loc.lon}`; a.target='_blank'; a.rel='noopener'; a.textContent='Google Maps öffnen'; a.style.color='#93c5fd'; endMap.appendChild(a); }
  $('#endOverlay').classList.add('show');
  const hist=loadHist(); hist.unshift({start:st.start,end:NOW(),plannedEnd:st.end,photo:st.photo,loc:st.loc}); saveHist(hist);
  st=defState(); saveState(); clearBadge();
}

/* ===== Rendering & Nav ===== */
function renderTimerUI(){
  if(st.photo){ $('#photoWrap').style.display='block'; $('#photo').src=st.photo; } else { $('#photoWrap').style.display='none'; }
  showMapBtn();
  if(st.running){ nav('#screenTimer'); runTick(); }
  else { $('#countdown').textContent='00:00:00'; setRingProgress(0); }
}
function nav(id){ $$('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }

/* ===== Share & Map ===== */
async function share(){
  if(!st.loc){ toast('Kein Standort gespeichert'); return; }
  const lines=['Parkplatz – geteilt mit ParkWecker',`Karte: https://maps.google.com/?q=${st.loc.lat},${st.loc.lon}`];
  if(st.photo) lines.push('(Foto angehängt, falls möglich)');
  const text=lines.join('\n');
  if(navigator.canShare && st.photo){
    try{
      const blob=dataURLtoBlob(st.photo); const file=new File([blob],'parkplatz.jpg',{type:'image/jpeg'});
      if(navigator.canShare({files:[file]})){ await navigator.share({title:'Parkplatz', text, files:[file]}); toast('Geteilt'); return; }
    }catch(e){}
  }
  if(navigator.share){ try{ await navigator.share({title:'Parkplatz', text}); toast('Geteilt'); return; }catch(e){} }
  try{ await navigator.clipboard.writeText(text); toast('Link kopiert'); }catch(e){ alert(text); }
}
function openMap(){ if(!st.loc){ toast('Kein Standort'); return; } window.open(`https://maps.google.com/?q=${st.loc.lat},${st.loc.lon}`,'_blank'); }
function dataURLtoBlob(dataUrl){
  const [meta, data] = dataUrl.split(','); const mime = meta.match(/:(.*?);/)[1];
  const bin = atob(data); const arr = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr], {type:mime});
}

/* ===== History ===== */
function renderHistory(){
  const data=loadHist(); const list=$('#historyList'); const none=$('#historyNone'); list.innerHTML=''; none.style.display=data.length?'none':'block';
  data.slice(0,3).forEach(item=>{
    const row=document.createElement('div'); row.className='row';
    const img=document.createElement('img'); img.className='thumb'; img.alt='Foto'; img.src=item.photo || placeholder();
    const col=document.createElement('div');
    const locTxt = item.loc ? ` • <a href="https://maps.google.com/?q=${item.loc.lat},${item.loc.lon}" target="_blank" rel="noopener" style="color:#93c5fd">Karte</a>` : '';
    col.innerHTML = `<div><strong>${new Date(item.start).toLocaleDateString()} ${new Date(item.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</strong></div>
      <div class="meta">Dauer: ${fmt((item.end||item.plannedEnd)-item.start)}${locTxt}</div>`;
    const tag=document.createElement('div'); tag.className='pill'; tag.textContent='Eintrag';
    row.append(img,col,tag); list.appendChild(row);
  });
}
function placeholder(){
  const c=document.createElement('canvas'); c.width=112;c.height=80; const x=c.getContext('2d');
  x.fillStyle='#0b0b0b'; x.fillRect(0,0,c.width,c.height);
  x.strokeStyle='rgba(255,255,255,.6)'; x.lineWidth=2; x.strokeRect(10,10,92,60);
  x.beginPath(); x.moveTo(20,55); x.lineTo(45,35); x.lineTo(65,48); x.lineTo(82,30); x.stroke();
  return c.toDataURL('image/png');
}

/* ===== Scroll-Picker Engine ===== */
const ITEM_H = 48;

function ensureVpHeight(vp){
  if(vp.clientHeight === 0){
    const parent = vp.closest('.wheel');
    if(parent) parent.style.height = '160px';
  }
}
function buildWheel(vp, values, initialIndex=0){
  ensureVpHeight(vp);
  const halfRows = Math.max(1, Math.floor(vp.clientHeight/ITEM_H/2));
  const padPx = halfRows*ITEM_H;
  vp.innerHTML = '';
  const padTop = document.createElement('div'); padTop.style.height = padPx+'px';
  const padBot = document.createElement('div'); padBot.style.height = padPx+'px';
  const frag=document.createDocumentFragment();
  frag.appendChild(padTop);

  values.forEach(v=>{
    const d=document.createElement('div'); d.className='item';
    d.textContent=String(v); // ohne führende Nullen
    frag.appendChild(d);
  });
  frag.appendChild(padBot);
  vp.appendChild(frag);

  requestAnimationFrame(()=>snapToIndex(vp, initialIndex, false));
  const snapLater = ()=>setTimeout(()=>snapToNearest(vp), 80);
  vp.addEventListener('scroll', ()=>highlight(vp));
  vp.addEventListener('touchend', snapLater);
  vp.addEventListener('mouseup',  snapLater);
  vp.addEventListener('wheel',    snapLater, {passive:true});
  highlight(vp);
}
function currentIndex(vp){
  const halfRows = Math.max(1, Math.floor(vp.clientHeight/ITEM_H/2));
  const firstTop = halfRows*ITEM_H;
  const center = vp.scrollTop + vp.clientHeight/2;
  const rel = center - firstTop - ITEM_H/2;
  return Math.max(0, Math.round(rel/ITEM_H));
}
function snapToNearest(vp){ snapToIndex(vp, currentIndex(vp)); }
function snapToIndex(vp, idx, smooth=true){
  const halfRows = Math.max(1, Math.floor(vp.clientHeight/ITEM_H/2));
  const pad = halfRows*ITEM_H;
  const target = pad + idx*ITEM_H - (vp.clientHeight/2 - ITEM_H/2);
  vp.scrollTo({top: target, behavior: smooth?'smooth':'auto'});
  highlight(vp, idx);
}
function highlight(vp, forcedIdx){
  const items=[...vp.querySelectorAll('.item')];
  const idx = forcedIdx!==undefined ? forcedIdx : currentIndex(vp);
  items.forEach((el,i)=>el.classList.toggle('sel', i===idx));
}
function readValue(vp, values){ return values[Math.min(values.length-1, currentIndex(vp))] }

/* ===== Manifest & SW ===== */
function canvasIconParkWecker(size){
  const c=document.createElement('canvas'); c.width=c.height=size; const x=c.getContext('2d');
  const g=x.createLinearGradient(0,0,size,size); g.addColorStop(0, '#1e40af'); g.addColorStop(1, '#06b6d4');
  x.fillStyle=g; x.fillRect(0,0,size,size);
  x.strokeStyle='rgba(255,255,255,.14)'; x.lineWidth=size*0.01; x.strokeRect(size*0.02,size*0.02,size*0.96,size*0.96);
  x.save(); x.translate(size*0.5, size*0.5);
  x.strokeStyle='#fff'; x.lineCap='round'; x.lineWidth=size*0.08; x.beginPath(); x.arc(0,0,size*0.28,0,Math.PI*2); x.stroke();
  x.lineWidth=size*0.06; x.beginPath(); x.moveTo(0,0); x.lineTo(0,-size*0.17); x.stroke();
  x.beginPath(); x.moveTo(0,0); x.lineTo(size*0.14,size*0.07); x.stroke();
  x.fillStyle='#fff'; x.beginPath(); x.arc(0,0,size*0.035,0,Math.PI*2); x.fill(); x.restore();
  const bx=size*0.62, by=size*0.62, bw=size*0.24, br=size*0.06;
  x.fillStyle='#fff'; roundedRect(x,bx-bw/2,by-bw/2,bw,bw,br); x.fill();
  x.fillStyle='#1247C6';
  x.beginPath(); pathRoundedRect(x, bx-bw*0.23, by-bw*0.32, bw*0.16, bw*0.64, bw*0.05); x.fill();
  x.beginPath(); x.moveTo(bx-bw*0.07, by-bw*0.18); x.lineTo(bx+bw*0.18, by-bw*0.18);
  x.quadraticCurveTo(bx+bw*0.30, by-bw*0.18, bx+bw*0.30, by-bw*0.02);
  x.quadraticCurveTo(bx+bw*0.30, by+bw*0.14, bx+bw*0.18, by+bw*0.14);
  x.lineTo(bx-bw*0.07, by+bw*0.14); x.closePath(); x.fill();
  return c.toDataURL('image/png');
  function roundedRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); }
  function pathRoundedRect(ctx,x,y,w,h,r){ ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); }
}
function createManifestAndSW(){
  const icons=[192,512].map(s=>({src:canvasIconParkWecker(s),sizes:`${s}x${s}`,type:'image/png',purpose:'any maskable'}));
  const screens=[[640,1136],[750,1334],[1242,2688],[1280,720]].map(([w,h])=>({src:canvasIconParkWecker(512),sizes:`${w}x${h}`,type:'image/png'}));
  const manifest={
    name:"ParkWecker – Parkschein-Timer",
    short_name:"ParkWecker",
    description:"Parkzeit wählen oder per Scroll-Picker einstellen, Foto/Standort sichern – rechtzeitig erinnert. Offline & installierbar.",
    start_url:".", scope:".", display:"standalone", orientation:"portrait",
    background_color:"#0f172a", theme_color:"#0f172a",
    categories:["productivity","utilities"], icons, screenshots:screens,
    shortcuts:[{name:"30 Minuten starten", url:"./?quick=30", icons:[icons[0]]},{name:"1 Stunde starten", url:"./?quick=60", icons:[icons[0]]}]
  };
  const link=document.createElement('link'); link.rel='manifest';
  link.href=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}));
  document.head.appendChild(link);

  if('serviceWorker' in navigator && window.isSecureContext){
    const sw=`
      const CACHE='parkw-v10';
      const CORE=['./'];
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE))); self.skipWaiting(); });
      self.addEventListener('activate',e=>{ e.waitUntil((async()=>{ const ks=await caches.keys(); await Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))); })()); self.clients.claim(); });
      self.addEventListener('fetch',e=>{
        const {request}=e;
        if(request.method!=='GET') return;
        e.respondWith((async()=>{
          const cache=await caches.open(CACHE);
          const cached=await cache.match(request);
          try{
            const fresh=await fetch(request);
            if(fresh && fresh.status===200 && fresh.type==='basic'){ cache.put(request,fresh.clone()); }
            return cached || fresh;
          }catch(err){
            return cached || new Response('Offline', {status:503, headers:{'Content-Type':'text/plain'}});
          }
        })());
      });
    `;
    const swURL=URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
    navigator.serviceWorker.register(swURL).catch(()=>{});
  }
}

/* ===== Build Wheels & Wiring ===== */
let hours, mins, remVals;
function buildAllWheels(){
  hours = Array.from({length:24},(_,i)=>i);
  mins  = Array.from({length:60},(_,i)=>i);
  remVals=[0,5,10,15,20,25];

  buildWheel($('#vpH'), hours, 0);
  buildWheel($('#vpM'), mins, 0);

  const remIndex = Math.max(0, remVals.indexOf(reminderMin));
  buildWheel($('#vpR'), remVals, remIndex);
}

function boot(){
  createManifestAndSW();

  // Preset-Buttons
  $$('.start').forEach(b=>{
    b.addEventListener('click',()=>{
      const m = parseInt(b.dataset.min,10);
      if(Number.isFinite(m) && m>0) startFlow(m);
    });
  });

  // Wheels
  buildAllWheels();

  // Erinnerung persistieren
  const vpR = $('#vpR');
  let remSnapTO=null;
  const persistReminder = ()=>{
    if(remSnapTO) clearTimeout(remSnapTO);
    remSnapTO=setTimeout(()=>{
      const v = readValue(vpR, remVals);
      if(v!==reminderMin){ reminderMin = v; saveReminder(v); toast(`Erinnerung: ${v} Min`); }
    }, 120);
  };
  vpR.addEventListener('scroll', persistReminder);
  vpR.addEventListener('touchend', persistReminder);
  vpR.addEventListener('mouseup', persistReminder);

  // Manueller Start
  $('#btnManualStart').addEventListener('click',()=>{
    const h = readValue($('#vpH'), hours);
    const m = readValue($('#vpM'), mins);
    const total = h*60 + m;
    if(total<=0){ alert('Bitte eine Parkdauer größer 0 einstellen.'); return; }
    startFlow(total);
  });

  // Header Navigation
  $('#brandHome').addEventListener('click',()=>{ if(photoWaitActive) return; stopCam(); nav('#screenStart'); });
  $('#btnTimer').addEventListener('click',()=>{ if(photoWaitActive) return; renderTimerUI(); nav('#screenTimer'); });
  $('#btnHistory').addEventListener('click',()=>{ if(photoWaitActive) return; renderHistory(); nav('#screenHistory'); });
  $('#btnSettings').addEventListener('click',()=>{
    if(photoWaitActive) return;
    $('#settingsOverlay').classList.add('show');
    $('#togSound').checked=cfg.sound; $('#togVib').checked=cfg.vibrate;
    highlightAlarmSelection();
  });
  $('#btnCloseSettings').addEventListener('click',()=>$('#settingsOverlay').classList.remove('show'));
  $('#btnNotif').addEventListener('click', async ()=>{
    if('Notification' in window && Notification.permission==='default'){
      try{ await Notification.requestPermission(); toast('System-Benachrichtigungen: '+Notification.permission); }catch(e){}
    }else{
      toast('System-Benachrichtigungen: '+(Notification?.permission||'nicht verfügbar'));
    }
  });

  // Toggles
  $('#togSound').addEventListener('change',e=>{ cfg.sound=!!e.target.checked; saveCfg(); vib(10); blip(900,60); });
  $('#togVib').addEventListener('change',e=>{ cfg.vibrate=!!e.target.checked; saveCfg(); vib(10); });

  // Alarm selection & preview
  $$('.alarm-select').forEach(btn=>{
    btn.addEventListener('click',()=>{
      cfg.alarmType = parseInt(btn.dataset.type,10)||2;
      saveCfg();
      toast(['','Glocken','Modern','Melodie'][cfg.alarmType] + ' gewählt');
      highlightAlarmSelection();
      vib(10); blip(900,60);
    });
  });
  $$('.alarm-test').forEach(btn=>{
    btn.addEventListener('click',()=>{
      unlockAudio();
      const t=parseInt(btn.dataset.type,10)||2;
      ({1:playBell,2:playModern,3:playMelody}[t]||playModern)(true);
      vib([30,40,30]);
    });
  });

  // Timer actions
  $('#btnPlus30').addEventListener('click',()=>extendTimer(30));
  $('#btnPlus60').addEventListener('click',()=>extendTimer(60));
  $('#btnStop').addEventListener('click',()=>stopTimer(true));

  // Photo actions
  $('#btnTakePhoto').addEventListener('click',async()=>{ if(!stream){ await startCam(); return; } capturePhoto(); });
  $('#btnRetake').addEventListener('click',async()=>{ st.photo=null; saveState(); renderPhoto(); await startCam(); });
  $('#photoWrap').addEventListener('click',async(e)=>{ if(['btnTakePhoto','btnRetake','btnSkipPhoto','fileInput'].includes(e.target.id)) return; await startCam(); });

  // Map & share
  $('#btnShowMap').addEventListener('click',openMap);
  $('#btnShare').addEventListener('click',share);

  // End overlay
  $('#btnStopAlarm').addEventListener('click',()=>{ stopAlarmLoop(); $('#endOverlay').classList.remove('show'); });
  $('#btnEndOk').addEventListener('click',()=>{ stopAlarmLoop(); $('#endOverlay').classList.remove('show'); renderHistory(); nav('#screenHistory'); });

  // Restore running timer
  if(st.running){ renderTimerUI(); } else { nav('#screenStart'); }

  // Shortcut
  const qp=new URLSearchParams(location.search); if(qp.get('quick')){ const m=parseInt(qp.get('quick'),10); if(m>0) startFlow(m); }

  // Rebuild wheels on resize/orientation
  let rebuildTO=null;
  window.addEventListener('resize', ()=>{
    if(rebuildTO) cancelAnimationFrame(rebuildTO);
    rebuildTO=requestAnimationFrame(()=>buildAllWheels());
  });
}

function highlightAlarmSelection(){
  $$('.alarm-select').forEach(b=>{
    const t=parseInt(b.dataset.type,10)||2;
    b.classList.toggle('primary', t===cfg.alarmType);
    b.classList.toggle('flat', t!==cfg.alarmType);
  });
}

window.addEventListener('load',boot,{once:true});
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible' && st.running){ updateCountdown(); } });
document.addEventListener('click',e=>{ if(e.target.closest('button')) vib(5); }, {passive:true});

/* ===== Orchestrated Flow – Standort -> Foto -> Start ===== */
async function startFlow(minutes){
  if(flowLock) return;
  flowLock = true;
  try{
    nav('#screenTimer');

    // 1) Standort zuerst
    const wantLoc = await showPrompt('Standort speichern?', 'So findest du den Platz direkt auf der Karte.');
    if(wantLoc){ await askGeo(); showMapBtn(); }

    // 2) Foto danach
    const wantPhoto = await showPrompt('Foto vom Parkplatz machen?', 'Hilft dir, dein Auto schneller wiederzufinden.');
    if(wantPhoto){
      $('#photoWrap').style.display='block';
      await startCam();
      await waitForPhotoDecision(); // wartet wirklich bis Foto/Skip
      stopCam();
    }else{
      st.photo=null; saveState(); renderPhoto();
    }

    // 3) Timer starten
    unlockAudio(); // Audio bereits im User-Flow aktivieren
    startTimer(minutes);
  } finally {
    flowLock = false;
  }
}

/* ===== Helpers ===== */
function dataURLtoBlob(dataUrl){
  const [meta, data] = dataUrl.split(','); const mime = meta.match(/:(.*?);/)[1];
  const bin = atob(data); const arr = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr], {type:mime});
}

/* Inline spinner keyframes (for camera label) */
const style=document.createElement('style'); style.textContent='@keyframes rspin{to{transform:rotate(360deg)}}'; document.head.appendChild(style);

/* Manifest & SW */
createManifestAndSW();

})();
</script>
</body>
</html>
