<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <title>ParkWecker – Parkschein-Timer</title>

  <!-- Viewport & PWA Meta -->
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="format-detection" content="telephone=no,email=no,address=no"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#0f172a"/>
  <meta name="application-name" content="ParkWecker"/>
  <meta name="description" content="Parkzeit wählen oder per Scroll-Picker einstellen, Foto/Standort sichern – rechtzeitig erinnert. Offline & installierbar."/>

  <!-- Icons -->
  <link rel="icon" sizes="192x192" href="icon-192.png" type="image/png"/>
  <link rel="icon" sizes="512x512" href="icon-512.png" type="image/png"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="ParkWecker"/>

  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827;
      --accent1:#7c3aed; --accent2:#06b6d4;
      --warn:#f59e0b; --danger:#ef4444;
      --surface:rgba(255,255,255,.06); --surface2:rgba(255,255,255,.1);
      --text:#e5e7eb; --muted:#cbd5e1;
      --glass: blur(14px) saturate(120%);
      --shadow:0 18px 45px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(1000px 700px at -10% 20%, rgba(6,182,212,.22), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }
    .app{
      min-height:100%;
      display:grid; grid-template-rows:auto 1fr; gap:12px;
      padding:max(10px,env(safe-area-inset-top)) max(10px,env(safe-area-inset-right))
              calc(18px + env(safe-area-inset-bottom)) max(10px,env(safe-area-inset-left));
    }

    /* Header */
    header{display:flex; align-items:center; justify-content:space-between;}
    .brand{display:flex; gap:10px; align-items:center; font-weight:800; cursor:pointer}
    h1{font-size:18px; margin:0}
    .icon-btn{
      border:none; background:var(--surface); border:1px solid rgba(255,255,255,.08);
      width:44px; height:44px; border-radius:14px; display:grid; place-items:center;
      box-shadow:var(--shadow); backdrop-filter: var(--glass);
      transition: transform .12s ease, box-shadow .25s ease, background .25s ease;
    }
    .icon-btn:active{ transform:scale(.98) }

    /* App-Icon (CSS/SVG) */
    .pw-icon{--size: 30px; --radius: 30%; width:var(--size); height:var(--size);
      border-radius:var(--radius); position:relative; overflow:hidden; display:grid; place-items:center;
      background: radial-gradient(120% 100% at 80% 10%, rgba(255,255,255,.18), transparent 55%),
                  linear-gradient(135deg, #1e40af 0%, #06b6d4 100%);
      box-shadow: inset 0 0 10px rgba(255,255,255,.12);
    }
    .pw-icon::after{content:""; position:absolute; inset:0; border-radius:inherit; box-shadow: inset 0 0 0 1px rgba(255,255,255,.14);}
    .pw-symbol{ width:70%; height:70%; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); }

    /* Screens */
    .screen{display:none; animation:fade .24s ease-out}
    .screen.active{display:block}
    @keyframes fade{from{opacity:.0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

    /* Haupt-Card (eine Box) */
    .card{
      background: var(--surface); border:1px solid rgba(255,255,255,.08);
      border-radius: var(--r); box-shadow: var(--shadow);
      backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
      padding:12px;
    }
    .section{ padding:10px 4px; }
    .section h2{margin:0 0 8px; font-size:17px}
    .section-divider{height:1px; background:rgba(255,255,255,.14); margin:6px 0;}

    /* Buttons */
    .btn{
      border:none; border-radius:16px; padding:16px; min-height:60px; font-weight:800;
      color:#fff; background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow);
      transition: transform .08s ease, filter .25s ease, background .25s ease;
      width:100%; display:flex; align-items:center; justify-content:center;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{background:linear-gradient(135deg, var(--accent2), var(--accent1));}
    .btn.flat{background:var(--surface); border:1px solid rgba(255,255,255,.08)}
    .btn.warn{background:linear-gradient(135deg, var(--warn), #fbbf24); color:#111}
    .btn.danger{background:linear-gradient(135deg, var(--danger), #f87171);}
    .btn.small{min-height:56px; padding:14px; border-radius:14px}
    .start-grid{display:grid; grid-template-columns:1fr; gap:10px; margin-top:2px}
    @media(min-width:420px){ .start-grid{grid-template-columns:repeat(3,1fr)} }

    /* Scroll-Picker */
    .wheels{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .wheel{
      position:relative; height:160px; border-radius:14px; overflow:hidden;
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 6px 16px rgba(0,0,0,.25), inset 0 -6px 16px rgba(0,0,0,.25);
    }
    .wheel .viewport{height:100%; overflow-y:auto; scroll-snap-type:y mandatory; scrollbar-width:none; -ms-overflow-style:none; overscroll-behavior-y:contain}
    .wheel .viewport::-webkit-scrollbar{display:none}
    .item{
      height:48px; display:flex; align-items:center; justify-content:center;
      font-size:20px; color:var(--muted); scroll-snap-align:center;
      transition: transform .12s ease, color .12s ease; font-variant-numeric: tabular-nums; line-height:1; user-select:none;
    }
    .item.sel{ color:#fff; transform:scale(1.16); font-weight:800; }
    .wheel::before, .wheel::after{content:""; position:absolute; left:8px; right:8px; height:0; border-top:1px dashed rgba(255,255,255,.22)}
    .wheel::before{ top: calc(50% - 24px); } .wheel::after{ top: calc(50% + 24px); }
    .wheel.single{ grid-column:1/-1; }

    /* Timer-Kreis */
    .timer-wrap{display:grid; gap:12px}
    .ring{ position:relative; width:100%; max-width:520px; margin:0 auto; aspect-ratio:1/1; display:grid; place-items:center; filter: drop-shadow(0 18px 45px rgba(0,0,0,.45)); }
    .ring svg{width:100%; height:100%}
    .ring .time{ position:absolute; width:100%; text-align:center; z-index:2; font-variant-numeric: tabular-nums; letter-spacing:.6px; top:50%; left:50%; transform:translate(-50%,-50%); }
    .time .big{font-size:44px; font-weight:800}

    /* Foto */
    .photo-wrap{ position:relative; border-radius:18px; overflow:hidden; background:#0b0b0b; aspect-ratio:16/9; display:none; place-items:center;
      border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); backdrop-filter:var(--glass); margin-top:4px; }
    .photo-wrap img,.photo-wrap video,.photo-wrap canvas{width:100%; height:100%; object-fit:cover}
    .tap-overlay{ position:absolute; inset:auto 0 0 0; background:linear-gradient(180deg, transparent, rgba(0,0,0,.55)); color:#fff; padding:8px 12px; font-size:13px; text-align:center; opacity:0; transition:opacity .25s ease; pointer-events:none; z-index:2 }
    .photo-wrap:hover .tap-overlay{opacity:1}
    .chip{ background:rgba(0,0,0,.5); color:#fff; border:none; border-radius:12px; padding:10px 12px; min-height:44px; min-width:44px; font-size:15px; border:1px solid rgba(255,255,255,.14); backdrop-filter: blur(8px); }

    /* Overlays */
    .overlay{position:fixed; inset:0; background:rgba(10,10,10,.6); display:none; align-items:center; justify-content:center; padding:14px; z-index:20}
    .overlay.show{display:flex}
    .modal{ width:100%; max-width:520px; background:var(--surface); border-radius:20px; box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.12); padding:14px; text-align:center; backdrop-filter:var(--glass) }
    .modal h3{margin:6px 0 4px}
    .modal p{margin:0 0 10px; color:var(--muted)}

    /* Verlauf */
    .history{display:grid; gap:8px}
    .row{ display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:8px;
      border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); backdrop-filter:var(--glass) }
    .thumb{width:56px; height:40px; object-fit:cover; border-radius:8px; background:#111; border:1px solid rgba(255,255,255,.1)}
    .meta{font-size:13px; color:#e5e7eb80}
    .pill{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); font-size:12px; color:#e5e7eb9c}

    /* Toast & A2HS */
    #toast{position:fixed; top:14px; left:50%; transform:translateX(-50%); display:none; padding:8px 12px; border-radius:999px; background:rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.15); z-index:50}
    #btnA2HS{display:none; position:fixed; left:50%; transform:translateX(-50%); bottom:calc(18px + env(safe-area-inset-bottom)); z-index:30;
      background:linear-gradient(135deg, var(--accent2), var(--accent1)); color:#fff; border:none; border-radius:14px; padding:14px 18px; font-weight:800; box-shadow: var(--shadow); }

    @media (max-height: 700px){ .wheel{height:140px}.item{font-size:19px}.btn.small{min-height:52px}.start-grid{gap:8px} }
    @media (max-height: 600px){ .wheel{height:128px}.item{font-size:18px} }
    @media (max-width: 360px){ .item{font-size:18px}.btn{min-height:56px}.wheels{gap:8px} }
  </style>
</head>
<body>
<div class="app" id="appRoot">
  <!-- Header -->
  <header>
    <div class="brand" id="brandHome" title="Zur Startseite">
      <div class="pw-icon" aria-hidden="true">
        <svg viewBox="0 0 100 100" class="pw-symbol">
          <circle cx="50" cy="50" r="28" fill="none" stroke="white" stroke-width="8" stroke-linecap="round"/>
          <line x1="50" y1="50" x2="50" y2="33" stroke="white" stroke-width="6" stroke-linecap="round"/>
          <line x1="50" y1="50" x2="64" y2="57" stroke="white" stroke-width="6" stroke-linecap="round"/>
          <circle cx="50" cy="50" r="3.5" fill="white"/>
          <g transform="translate(62,62)">
            <rect x="-12" y="-12" width="24" height="24" rx="6" fill="white"/>
            <path d="M -5 8 V -8 H 3.5 C 7 -8 10 -5.5 10 -2.2 C 10 1.0 7 3.5 3.5 3.5 H -1.5 V 8 Z
                     M -1.5 0 H 3.2 C 4.9 0 6.2 -1.2 6.2 -2.2 C 6.2 -3.3 4.9 -4.5 3.2 -4.5 H -1.5 V 0 Z"
                  fill="#1247C6"/>
          </g>
        </svg>
      </div>
      <h1>ParkWecker</h1>
    </div>
    <div style="display:flex; gap:8px">
      <button class="icon-btn" id="btnTimer" title="Timer" aria-label="Timer">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="13" r="8"/><path d="M12 9v4l3 2"/><path d="M9 2h6"/><path d="M19 4l-1.5 1.5"/>
        </svg>
      </button>
      <button class="icon-btn" id="btnHistory" title="Verlauf" aria-label="Verlauf">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 3-6.7"/><path d="M3 3v6h6"/><path d="M12 7v5l3 3"/>
        </svg>
      </button>
      <button class="icon-btn" id="btnSettings" title="Einstellungen" aria-label="Einstellungen">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.77 19l.06-.06a1.65 1.65 0 0 0 .33-1.82A1.65 1.65 0 0 0 3.65 15H3a2 2 0 1 1 0-4h.65A1.65 1.65 0 0 0 4.83 9 1.65 1.65 0 0 0 4.5 7.18L4.44 7.1A2 2 0 1 1 7.27 4.27l.06.06A1.65 1.65 0 0 0 9.15 4h.09A1.65 1.65 0 0 0 10.75 3V3a2 2 0 1 1 4 0v.06a1.65 1.65 0 0 0 1.51 1 1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 21 7.27l-.06.06A1.65 1.65 0 0 0 20 9.15v.09A1.65 1.65 0 0 0 21 10.75h.06A2 2 0 1 1 21 14h-.06a1.65 1.65 0 0 0-1.54 1z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- START -->
  <section id="screenStart" class="screen active">
    <div class="card main-container">
      <div class="section">
        <h2>Zeit wählen</h2>
        <div class="start-grid">
          <button class="btn primary start" data-min="15">15 Min</button>
          <button class="btn primary start" data-min="30">30 Min</button>
          <button class="btn primary start" data-min="60">1 Stunde</button>
        </div>
      </div>
      <div class="section-divider" aria-hidden="true"></div>

      <div class="section">
        <h2>Timer manuell einstellen</h2>
        <div class="wheels">
          <div class="wheel"><div class="viewport" id="vpH"></div></div>
          <div class="wheel"><div class="viewport" id="vpM"></div></div>
        </div>
        <div style="height:8px"></div>
        <button class="btn primary small" id="btnManualStart">START</button>
      </div>
      <div class="section-divider" aria-hidden="true"></div>

      <div class="section">
        <h2>Erinnerung vor Timer-Ende</h2>
        <div class="wheel single"><div class="viewport" id="vpR"></div></div>
        <p style="margin:8px 0 0; color:var(--muted); font-size:13px">Die Erinnerung wird automatisch vor Ablauf ausgelöst. Deine Auswahl wird gespeichert.</p>
      </div>
    </div>
  </section>

  <!-- TIMER -->
  <section id="screenTimer" class="screen">
    <div class="card timer-wrap">
      <div class="ring" id="ring">
        <svg viewBox="0 0 120 120">
          <defs><linearGradient id="gradStroke" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--accent2)"/><stop offset="100%" stop-color="var(--accent1)"/></linearGradient></defs>
          <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.1)" stroke-width="8" fill="none"/>
          <circle id="progress" cx="60" cy="60" r="52" stroke="url(#gradStroke)" stroke-width="8" stroke-linecap="round" stroke-dasharray="326.7256" stroke-dashoffset="0" fill="none" transform="rotate(-90 60 60)"/>
        </svg>
        <div class="time"><div class="big" id="countdown">00:00:00</div></div>
      </div>

      <div class="photo-wrap" id="photoWrap">
        <img id="photo" alt="Parkplatz-Foto"/>
        <video id="video" playsinline autoplay muted style="display:none"></video>
        <canvas id="canvas" style="display:none"></canvas>
        <div class="tap-overlay">Tippen, um ein neues Foto zu machen</div>
        <div style="position:absolute; bottom:10px; right:10px; display:flex; gap:8px;">
          <button id="btnTakePhoto" class="chip"><span id="camLabel">Kamera</span></button>
          <button id="btnRetake" class="chip" style="display:none">Neu</button>
          <button id="btnSkipPhoto" class="chip" style="display:none">Weiter ohne Foto</button>
          <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">
        <button class="btn flat small" id="btnShowMap" style="display:none">Standort anzeigen</button>
        <button class="btn flat small" id="btnShare" style="display:none">Teilen</button>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px">
        <button class="btn warn small" id="btnPlus30">+ 30 min</button>
        <button class="btn warn small" id="btnPlus60">+ 1 h</button>
        <button class="btn danger small" id="btnStop">Stoppen</button>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="screenHistory" class="screen">
    <div class="card">
      <h3 style="margin:6px 0 10px">Verlauf (letzte 3)</h3>
      <div class="history" id="historyList"></div>
      <div class="pill" id="historyNone">Noch keine Einträge.</div>
    </div>
  </section>

  <!-- PROMPTS -->
  <div class="overlay" id="promptOverlay">
    <div class="modal">
      <h3 id="promptTitle">Standort speichern?</h3>
      <p id="promptText">So findest du den Platz direkt auf der Karte.</p>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn primary small" id="promptYes">Ja</button>
        <button class="btn flat small" id="promptNo">Nein</button>
      </div>
    </div>
  </div>

  <!-- END OVERLAY -->
  <div class="overlay" id="endOverlay">
    <div class="modal">
      <h3>Timer beendet</h3>
      <p>Bitte Parkschein verlängern oder Platz wechseln.</p>
      <div id="endPhotoWrap" class="photo-wrap" style="margin-top:8px; display:none"><img id="endPhoto" alt="Foto"/></div>
      <div style="margin-top:10px" id="endMapWrap"></div>
      <div style="height:8px"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn danger" id="btnStopAlarm">Alarm stoppen</button>
        <button class="btn flat" id="btnEndOk">OK</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="overlay" id="settingsOverlay">
    <div class="modal">
      <h3>Einstellungen</h3>
      <div class="settings-group">
        <div style="font-weight:700; margin-bottom:2px">Alarmton wählen</div>
        <div class="alarm-row"><div>Glocken</div><button class="btn flat small alarm-select" data-type="1">Auswählen</button><button class="btn primary small alarm-test" data-type="1">Test</button></div>
        <div class="alarm-row"><div>Modern</div><button class="btn flat small alarm-select" data-type="2">Auswählen</button><button class="btn primary small alarm-test" data-type="2">Test</button></div>
        <div class="alarm-row"><div>Melodie</div><button class="btn flat small alarm-select" data-type="3">Auswählen</button><button class="btn primary small alarm-test" data-type="3">Test</button></div>
        <div style="font-size:12px; color:var(--muted)">Deine Auswahl wird gespeichert und für den nächsten Timer verwendet.</div>
      </div>
      <div class="settings-group">
        <label style="display:flex; align-items:center; justify-content:space-between; gap:10px">Ton <input id="togSound" type="checkbox" checked></label>
        <label style="display:flex; align-items:center; justify-content:space-between; gap:10px">Vibration <input id="togVib" type="checkbox" checked></label>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn flat" id="btnNotif">System-Benachrichtigungen erlauben</button>
        <button class="btn primary" id="btnCloseSettings">Schließen</button>
      </div>
    </div>
  </div>

  <div class="card" id="toast">OK</div>
  <button id="btnA2HS">Zum Startbildschirm hinzufügen</button>
</div>

<script>
(function(){
'use strict';

/* ===== Helpers ===== */
var $=function(s){return document.querySelector(s)};
var $$=function(s){return Array.prototype.slice.call(document.querySelectorAll(s))};
var NOW=function(){return Date.now()};
function safeBind(sel,evt,fn){ var el=$(sel); if(el){ try{ el.addEventListener(evt,fn); }catch(_){ } } return !!el; }
function toast(msg){ var t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(function(){ t.style.display='none'; }, 1400); }
function vib(p){ if(!cfg.vibrate) return; if(navigator.vibrate) navigator.vibrate(p); }
function isSecure(){ return (location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1'); }

/* ===== Storage Keys ===== */
var K_STATE='pw_state_v12';
var K_HIST ='pw_hist_v12';
var K_CFG  ='pw_cfg_v12';
var K_REM  ='pw_reminder_v4';

/* ===== State ===== */
var cfg = loadCfg();
var st  = loadState();
var tick=null; var reminderMin = loadReminder(); var reminderFired=false;
var camStream=null; var photoWaitActive=false; var flowLock=false;
var alarmLoopInt=null;

/* ===== Storage ===== */
function defState(){ return {running:false,start:0,end:0,photo:null,loc:null}; }
function loadState(){ try{ return JSON.parse(localStorage.getItem(K_STATE)) || defState(); }catch(e){return defState();} }
function saveState(){ localStorage.setItem(K_STATE, JSON.stringify(st)); }
function loadCfg(){ try{ return Object.assign({sound:true,vibrate:true,alarmType:2}, JSON.parse(localStorage.getItem(K_CFG)||'{}')); }catch(e){return {sound:true,vibrate:true,alarmType:2}} }
function saveCfg(){ localStorage.setItem(K_CFG, JSON.stringify(cfg)); }
function loadHist(){ try{ return JSON.parse(localStorage.getItem(K_HIST)) || []; }catch(e){return []} }
function saveHist(a){ localStorage.setItem(K_HIST, JSON.stringify(a.slice(0,3))); }
function loadReminder(){ try{ var v=JSON.parse(localStorage.getItem(K_REM)||'5'); return [0,5,10,15,20,25].indexOf(v)>-1?v:5; }catch(e){return 5} }
function saveReminder(v){ localStorage.setItem(K_REM, JSON.stringify(v)); }

/* ===== Timer Ring ===== */
var circ = 2 * Math.PI * 52; var $progress;
function setRingProgress(percent){ if(!$progress) $progress=$('#progress'); if(!$progress) return; var off=circ*(1-percent); $progress.style.strokeDasharray=String(circ); $progress.style.strokeDashoffset=String(off); }

/* ===== WebAudio Alarme ===== */
function AC(){ return window.AudioContext||window.webkitAudioContext; }
function tone(ctx,o){ var freq=o.freq||440, start=o.start||0, dur=o.dur||0.4, type=o.type||'sine', attack=o.attack||0.02, release=o.release||0.15, gain=o.gain||0.15;
  var osc=ctx.createOscillator(); var g=ctx.createGain(); osc.type=type; osc.frequency.value=freq; g.gain.value=0.0001;
  osc.connect(g).connect(ctx.destination); var t0=ctx.currentTime+start;
  g.gain.setValueAtTime(0.0001,t0); g.gain.exponentialRampToValueAtTime(gain,t0+attack);
  g.gain.exponentialRampToValueAtTime(0.0001,t0+dur); osc.start(t0); osc.stop(t0+dur+release);
}
function playBell(preview){ if(!cfg.sound||!AC())return; var ctx=new AC();
  [{f:261,t:0.0},{f:330,t:0.8},{f:392,t:1.6}].forEach(function(s){tone(ctx,{freq:s.f,start:s.t,dur:0.8,type:'sine',attack:0.04,release:0.3,gain:0.20});});
  setTimeout(function(){try{ctx.close();}catch(e){}}, (preview?1.6:2.6)*1000+150);
}
function playModern(preview){ if(!cfg.sound||!AC())return; var ctx=new AC();
  var reps=preview?2:3; for(var i=0;i<reps;i++) tone(ctx,{freq:800,start:i*1.3,dur:1.0,type:'sine',attack:0.02,release:0.12,gain:0.22});
  setTimeout(function(){try{ctx.close();}catch(e){}}, reps*1.3*1000+200);
}
function playMelody(preview){ if(!cfg.sound||!AC())return; var ctx=new AC();
  [261,294,330,392].forEach(function(f,i){ tone(ctx,{freq:f,start:i*0.42,dur:0.4,type:'triangle',attack:0.02,release:0.1,gain:0.18}); });
  setTimeout(function(){try{ctx.close();}catch(e){}}, 4*0.42*1000+200);
}
function playSelected(preview){ ({1:playBell,2:playModern,3:playMelody}[cfg.alarmType]||playModern)(preview); }
function startAlarmLoop(){ stopAlarmLoop(); playSelected(false); var d=cfg.alarmType===1?2600:cfg.alarmType===2?3900:1800; alarmLoopInt=setInterval(function(){playSelected(false);},d); }
function stopAlarmLoop(){ if(alarmLoopInt){clearInterval(alarmLoopInt); alarmLoopInt=null;} }

/* ===== Kamera mit Fallback ===== */
function stopCam(){ if(camStream){ try{ camStream.getTracks().forEach(function(t){t.stop();}); }catch(e){} camStream=null; } var v=$('#video'); if(v){ v.style.display='none'; } var skip=$('#btnSkipPhoto'); if(skip){ skip.style.display='none'; } }
async function startCam(){
  stopCam();
  if(!isSecure() || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    var cam=$('#camLabel'); if(cam) cam.textContent='Foto hochladen';
    var fi=$('#fileInput'); if(fi) fi.click();
    return;
  }
  try{
    var cam2=$('#camLabel'); if(cam2) cam2.textContent='Öffne…';
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    var v=$('#video'); if(!v) return; v.srcObject=camStream; v.style.display='block'; var img=$('#photo'); if(img) img.style.display='none';
    await new Promise(function(r){ if(v.readyState>=2) r(); else v.onloadedmetadata=function(){r();}; });
    if(cam2) cam2.textContent='Aufnehmen'; var sk=$('#btnSkipPhoto'); if(sk) sk.style.display='inline-block';
  }catch(e){
    var cam3=$('#camLabel'); if(cam3) cam3.textContent='Foto hochladen';
    var fi2=$('#fileInput'); if(fi2) fi2.click();
  }
}
async function capturePhoto(){
  var v=$('#video'); if(!v || !v.srcObject){ await startCam(); return; }
  if(v.videoWidth===0||v.videoHeight===0){ await new Promise(function(r){ var to=setTimeout(r,400); v.onloadeddata=function(){clearTimeout(to); r();}; }); }
  var cam=$('#camLabel'); if(cam) cam.textContent='Speichere…';
  await new Promise(function(r){ requestAnimationFrame(r); });
  var c=$('#canvas'), x=c.getContext('2d'); c.width=v.videoWidth||1280; c.height=v.videoHeight||720; x.drawImage(v,0,0,c.width,c.height);
  try{ st.photo=c.toDataURL('image/jpeg',0.9); saveState(); renderPhoto(); toast('Foto gespeichert'); vib(30); }
  catch(_){ toast('Konnte Foto nicht speichern'); }
  finally{ if(cam) cam.textContent='Aufnehmen'; stopCam(); }
  if(photoWaitActive) document.dispatchEvent(new CustomEvent('photo-decision',{detail:{status:'saved'}}));
}
safeBind('#fileInput','change',function(e){
  var f=e.target.files && e.target.files[0]; if(!f) return;
  var r=new FileReader(); r.onload=function(){ st.photo=String(r.result); saveState(); renderPhoto(); toast('Foto gespeichert'); vib(30);
    if(photoWaitActive) document.dispatchEvent(new CustomEvent('photo-decision',{detail:{status:'saved'}})); };
  r.readAsDataURL(f);
});
function renderPhoto(){ var wrap=$('#photoWrap'); if(!wrap) return; if(st.photo){ var p=$('#photo'); if(p){ p.src=st.photo; } wrap.style.display='block'; var rt=$('#btnRetake'); if(rt) rt.style.display='inline-block'; } else { wrap.style.display='none'; var rt2=$('#btnRetake'); if(rt2) rt2.style.display='none'; } }

/* ===== Geolocation ===== */
async function askGeo(){
  if(!('geolocation' in navigator)){ toast('GPS nicht verfügbar'); return false; }
  try{
    var pos=await new Promise(function(res,rej){ navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:8000,maximumAge:60000}); });
    st.loc={lat:pos.coords.latitude, lon:pos.coords.longitude, acc:pos.coords.accuracy}; saveState(); toast('Standort gespeichert'); vib(20); return true;
  }catch(_){ toast('GPS abgelehnt'); return false; }
}
function showMapBtn(){ var sM=$('#btnShowMap'), sh=$('#btnShare'); if(st.loc){ if(sM)sM.style.display='inline-block'; if(sh)sh.style.display='inline-block'; } else { if(sM)sM.style.display='none'; if(sh)sh.style.display='none'; } }

/* ===== Prompts ===== */
function showPrompt(title,text){
  if(photoWaitActive) return Promise.resolve(false);
  var ov=$('#promptOverlay'); if(!ov) return Promise.resolve(false);
  $('#promptTitle').textContent=title; $('#promptText').textContent=text; ov.classList.add('show');
  return new Promise(function(res){
    var yes=function(){ clean(); res(true); }, no=function(){ clean(); res(false); };
    $('#promptYes').onclick=yes; $('#promptNo').onclick=no;
    function clean(){ var y=$('#promptYes'), n=$('#promptNo'); if(y) y.onclick=null; if(n) n.onclick=null; ov.classList.remove('show'); }
  });
}
function waitForPhotoDecision(){
  photoWaitActive=true;
  return new Promise(function(res){
    var onDecision=function(e){ cleanup(); res((e.detail && e.detail.status) || 'skipped'); };
    var onSkip=function(){ stopCam(); st.photo=null; saveState(); renderPhoto(); cleanup(); res('skipped'); };
    function cleanup(){ photoWaitActive=false; document.removeEventListener('photo-decision',onDecision); var sk=$('#btnSkipPhoto'); if(sk) sk.onclick=null; if(sk) sk.style.display='none'; }
    document.addEventListener('photo-decision',onDecision,{once:true});
    var sk=$('#btnSkipPhoto'); if(sk) sk.onclick=onSkip;
  });
}

/* ===== Timer ===== */
function startTimer(minutes){
  var now=NOW(); st.start=now; st.end=now+minutes*60000; st.running=true; reminderFired=false;
  saveState(); runTick(); renderTimerUI(); toast('Timer gestartet'); vib(40);
}
function stopTimer(record){
  if(record===undefined) record=true;
  clearInterval(tick); tick=null; stopAlarmLoop();
  var ended=NOW();
  if(record && st.start && st.end){ var h=loadHist(); h.unshift({start:st.start,end:ended,plannedEnd:st.end,photo:st.photo,loc:st.loc}); saveHist(h); }
  st=defState(); saveState(); renderTimerUI(); nav('#screenStart');
}
function extendTimer(min){ if(!st.running) return; st.end+=min*60000; saveState(); updateCountdown(); toast('Verlängert'); vib(20); }
function runTick(){ if(tick) clearInterval(tick); tick=setInterval(updateCountdown,1000); updateCountdown(); }
function fmt(ms){ if(ms<0)ms=0; var s=Math.floor(ms/1000); var hh=String(Math.floor(s/3600)).padStart(2,'0'); var mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); var ss=String(s%60).padStart(2,'0'); return hh+':'+mm+':'+ss; }
function updateCountdown(){
  if(!st.running) return;
  var total=st.end-st.start, left=st.end-NOW(), leftPos=Math.max(left,0), pct=Math.min(Math.max(leftPos/Math.max(total,1),0),1);
  setRingProgress(pct); var c=$('#countdown'); if(c) c.textContent=fmt(left);
  var remMs = Math.max(0, reminderMin)*60000;
  if(remMs>0 && !reminderFired && left>0 && left<=remMs){
    reminderFired=true; playSelected(true); vib([200,100,200,100,200]); toast('Noch '+reminderMin+' Minuten.');
  }
  if(left<=0) onTimerEnd();
}
function onTimerEnd(){
  if(!st.running) return;
  startAlarmLoop(); vib([400,150,400,150,400,150,600]);
  clearInterval(tick); tick=null;
  if(st.photo){ var ep=$('#endPhoto'); if(ep) ep.src=st.photo; var epw=$('#endPhotoWrap'); if(epw) epw.style.display='block'; } else { var epw2=$('#endPhotoWrap'); if(epw2) epw2.style.display='none'; }
  var m=$('#endMapWrap'); if(m){ m.innerHTML=''; if(st.loc){ var a=document.createElement('a'); a.href='https://maps.google.com/?q='+st.loc.lat+','+st.loc.lon; a.target='_blank'; a.rel='noopener'; a.textContent='Google Maps öffnen'; a.style.color='#93c5fd'; m.appendChild(a); } }
  var ov=$('#endOverlay'); if(ov) ov.classList.add('show');
  var h=loadHist(); h.unshift({start:st.start,end:NOW(),plannedEnd:st.end,photo:st.photo,loc:st.loc}); saveHist(h);
  st=defState(); saveState();
}

/* ===== Render & Navigation ===== */
function renderTimerUI(){
  var wrap=$('#photoWrap'); if(st.photo && wrap){ wrap.style.display='block'; var p=$('#photo'); if(p) p.src=st.photo; } else if(wrap){ wrap.style.display='none'; }
  showMapBtn();
  if(st.running){ nav('#screenTimer'); runTick(); } else { var c=$('#countdown'); if(c) c.textContent='00:00:00'; setRingProgress(0); }
}
function nav(id){ $$('.screen').forEach(function(s){ s.classList.remove('active'); }); var t=$(id); if(t) t.classList.add('active'); }

/* ===== Share & Map ===== */
function openMap(){ if(!st.loc){ toast('Kein Standort'); return; } window.open('https://maps.google.com/?q='+st.loc.lat+','+st.loc.lon,'_blank'); }
async function share(){
  if(!st.loc){ toast('Kein Standort gespeichert'); return; }
  var lines=['Parkplatz – geteilt mit ParkWecker','Karte: https://maps.google.com/?q='+st.loc.lat+','+st.loc.lon];
  if(st.photo) lines.push('(Foto angehängt, falls möglich)');
  var text=lines.join('\n');
  if(navigator.canShare && st.photo){
    try{ var blob=dataURLtoBlob(st.photo); var file=new File([blob],'parkplatz.jpg',{type:'image/jpeg'}); if(navigator.canShare({files:[file]})){ await navigator.share({title:'Parkplatz', text:text, files:[file]}); toast('Geteilt'); return; } }catch(_){}
  }
  if(navigator.share){ try{ await navigator.share({title:'Parkplatz', text:text}); toast('Geteilt'); return; }catch(_){}
  try{ await navigator.clipboard.writeText(text); toast('Link kopiert'); }catch(_){ alert(text); }
}
function dataURLtoBlob(u){ var sp=u.split(','), m=sp[0], d=sp[1]; var mime=m.match(/:(.*?);/)[1]; var bin=atob(d); var arr=new Uint8Array(bin.length); for(var i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr],{type:mime}); }

/* ===== History ===== */
function renderHistory(){
  var data=loadHist(); var list=$('#historyList'); var none=$('#historyNone'); if(!list||!none) return;
  list.innerHTML=''; none.style.display=data.length?'none':'block';
  data.slice(0,3).forEach(function(item){
    var row=document.createElement('div'); row.className='row';
    var img=document.createElement('img'); img.className='thumb'; img.alt='Foto'; img.src=item.photo || placeholder();
    var col=document.createElement('div');
    var locTxt=item.loc?' • <a href="https://maps.google.com/?q='+item.loc.lat+','+item.loc.lon+'" target="_blank" rel="noopener" style="color:#93c5fd">Karte</a>':'';
    col.innerHTML='<div><strong>'+new Date(item.start).toLocaleDateString()+' '+new Date(item.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</strong></div>'
                 +'<div class="meta">Dauer: '+fmt((item.end||item.plannedEnd)-item.start)+locTxt+'</div>';
    var tag=document.createElement('div'); tag.className='pill'; tag.textContent='Eintrag';
    row.appendChild(img); row.appendChild(col); row.appendChild(tag); list.appendChild(row);
  });
}
function placeholder(){ var c=document.createElement('canvas'); c.width=112;c.height=80; var x=c.getContext('2d'); x.fillStyle='#0b0b0b'; x.fillRect(0,0,c.width,c.height); x.strokeStyle='rgba(255,255,255,.6)'; x.lineWidth=2; x.strokeRect(10,10,92,60); x.beginPath(); x.moveTo(20,55); x.lineTo(45,35); x.lineTo(65,48); x.lineTo(82,30); x.stroke(); return c.toDataURL('image/png'); }

/* ===== Scroll-Picker ===== */
var ITEM_H=48; var hours=[], mins=[], remVals=[0,5,10,15,20,25];
function buildWheel(vp, values, initialIndex){
  if(!vp) return;
  if(initialIndex===undefined) initialIndex=0;
  var parent=vp.closest('.wheel'); if(parent && parent.clientHeight===0) parent.style.height='160px';
  var half=Math.max(1,Math.floor((vp.clientHeight||160)/ITEM_H/2)); var pad=half*ITEM_H;
  vp.innerHTML='';
  var padTop=document.createElement('div'); padTop.style.height=pad+'px';
  var padBot=document.createElement('div'); padBot.style.height=pad+'px';
  var frag=document.createDocumentFragment(); frag.appendChild(padTop);
  for(var i=0;i<values.length;i++){ var d=document.createElement('div'); d.className='item'; d.textContent=String(values[i]); frag.appendChild(d); }
  frag.appendChild(padBot); vp.appendChild(frag);
  setTimeout(function(){ snapToIndex(vp,initialIndex,false); },0);
  var snapLater=function(){ setTimeout(function(){ snapToNearest(vp); },80); };
  vp.addEventListener('scroll',function(){ highlight(vp); });
  vp.addEventListener('touchend',snapLater); vp.addEventListener('mouseup',snapLater); vp.addEventListener('wheel',snapLater,{passive:true});
  highlight(vp);
}
function currentIndex(vp){ var half=Math.max(1,Math.floor((vp.clientHeight||160)/ITEM_H/2)); var firstTop=half*ITEM_H; var center=vp.scrollTop+vp.clientHeight/2; var rel=center-firstTop-ITEM_H/2; return Math.max(0,Math.round(rel/ITEM_H)); }
function snapToNearest(vp){ snapToIndex(vp,currentIndex(vp)); }
function snapToIndex(vp,idx,smooth){ if(smooth===undefined) smooth=true; var half=Math.max(1,Math.floor((vp.clientHeight||160)/ITEM_H/2)); var pad=half*ITEM_H; var target=pad+idx*ITEM_H-(vp.clientHeight/2-ITEM_H/2); vp.scrollTo({top:target,behavior:smooth?'smooth':'auto'}); highlight(vp,idx); }
function highlight(vp,forced){ var items=Array.prototype.slice.call(vp.querySelectorAll('.item')); var idx=(forced!==undefined)?forced:currentIndex(vp); for(var i=0;i<items.length;i++){ items[i].classList.toggle('sel',i===idx); } }
function readValue(vp,values){ var idx=currentIndex(vp); if(idx<0) idx=0; if(idx>=values.length) idx=values.length-1; return values[idx]; }

/* ===== A2HS & SW ===== */
var deferredPrompt=null; var a2hsBtn;
function setupA2HS(){
  a2hsBtn=$('#btnA2HS');
  window.addEventListener('beforeinstallprompt',function(e){ e.preventDefault(); deferredPrompt=e; if(a2hsBtn) a2hsBtn.style.display='block'; });
  if(a2hsBtn) a2hsBtn.addEventListener('click',async function(){ if(!deferredPrompt) return; a2hsBtn.style.display='none'; deferredPrompt.prompt(); try{ var c=await deferredPrompt.userChoice; toast(c.outcome==='accepted'?'Installiert':'Installation abgebrochen'); }catch(_){ } deferredPrompt=null; });
  window.addEventListener('appinstalled',function(){ toast('ParkWecker installiert'); if(a2hsBtn) a2hsBtn.style.display='none'; deferredPrompt=null; });
}
async function registerSW(){ if(!('serviceWorker' in navigator)) return; try{ await navigator.serviceWorker.register('./service-worker.js'); }catch(_){ } }

/* ===== Boot ===== */
function boot(){
  try{
    // Zeit-Buttons
    $$('.start').forEach(function(b){ b.addEventListener('click',function(){ var m=+b.dataset.min; if(m>0) startFlow(m); }); });

    // Scroll-Picker Inhalte
    hours=[]; for(var i=0;i<24;i++) hours.push(i);
    mins=[];  for(var j=0;j<60;j++) mins.push(j);
    buildWheel($('#vpH'),hours,0);
    buildWheel($('#vpM'),mins,0);
    var rIdx=Math.max(0,remVals.indexOf(reminderMin)); buildWheel($('#vpR'),remVals,rIdx);

    // Reminder-Persist
    var vpR=$('#vpR'); var remTO=null;
    function persist(){ if(remTO) clearTimeout(remTO); remTO=setTimeout(function(){ var v=readValue(vpR,remVals); if(v!==reminderMin){ reminderMin=v; saveReminder(v); toast('Erinnerung: '+v+' Min'); } },120); }
    if(vpR){ vpR.addEventListener('scroll',persist); vpR.addEventListener('touchend',persist); vpR.addEventListener('mouseup',persist); }

    // Manueller Start
    safeBind('#btnManualStart','click',function(){ var h=readValue($('#vpH'),hours); var m=readValue($('#vpM'),mins); var total=h*60+m; if(total<=0){ alert('Bitte eine Parkdauer größer 0 einstellen.'); return; } startFlow(total); });

    // Header Nav
    safeBind('#brandHome','click',function(){ if(photoWaitActive) return; stopCam(); nav('#screenStart'); });
    safeBind('#btnTimer','click',function(){ if(photoWaitActive) return; renderTimerUI(); nav('#screenTimer'); });
    safeBind('#btnHistory','click',function(){ if(photoWaitActive) return; renderHistory(); nav('#screenHistory'); });
    safeBind('#btnSettings','click',function(){ if(photoWaitActive) return; var ov=$('#settingsOverlay'); if(!ov) return; ov.classList.add('show'); var ts=$('#togSound'), tv=$('#togVib'); if(ts) ts.checked=cfg.sound; if(tv) tv.checked=cfg.vibrate; highlightAlarmSelection(); });
    safeBind('#btnCloseSettings','click',function(){ var ov=$('#settingsOverlay'); if(ov) ov.classList.remove('show'); });
    safeBind('#btnNotif','click', async function(){ if('Notification'in window && Notification.permission==='default'){ try{ await Notification.requestPermission(); toast('System-Benachrichtigungen: '+Notification.permission);}catch(_){ } } else { toast('System-Benachrichtigungen: '+(window.Notification?Notification.permission:'nicht verfügbar')); }});

    // Settings toggles
    safeBind('#togSound','change',function(e){ cfg.sound=!!e.target.checked; saveCfg(); vib(10); });
    safeBind('#togVib','change',function(e){ cfg.vibrate=!!e.target.checked; saveCfg(); vib(10); });
    $$('.alarm-select').forEach(function(btn){ btn.addEventListener('click',function(){ cfg.alarmType=parseInt(btn.dataset.type,10)||2; saveCfg(); toast((['','Glocken','Modern','Melodie'][cfg.alarmType])+' gewählt'); highlightAlarmSelection(); vib(10); }); });
    $$('.alarm-test').forEach(function(btn){ btn.addEventListener('click',function(){ var t=parseInt(btn.dataset.type,10)||2; ({1:playBell,2:playModern,3:playMelody}[t]||playModern)(true); vib([30,40,30]); }); });

    // Timer-Aktionen
    safeBind('#btnPlus30','click',function(){ extendTimer(30); });
    safeBind('#btnPlus60','click',function(){ extendTimer(60); });
    safeBind('#btnStop','click',function(){ stopTimer(true); });

    // Foto-Aktionen
    safeBind('#btnTakePhoto','click',async function(){ var v=$('#video'); if(!v || !v.srcObject){ await startCam(); return; } capturePhoto(); });
    safeBind('#btnRetake','click',async function(){ st.photo=null; saveState(); renderPhoto(); await startCam(); });
    var pw=$('#photoWrap'); if(pw){ pw.addEventListener('click',async function(e){ var id=(e.target&&e.target.id)||''; if(id==='btnTakePhoto'||id==='btnRetake'||id==='btnSkipPhoto'||id==='fileInput') return; await startCam(); }); }

    // Map & Share
    safeBind('#btnShowMap','click',openMap);
    safeBind('#btnShare','click',share);

    // End-Overlay
    safeBind('#btnStopAlarm','click',function(){ stopAlarmLoop(); var ov=$('#endOverlay'); if(ov) ov.classList.remove('show'); });
    safeBind('#btnEndOk','click',function(){ stopAlarmLoop(); var ov=$('#endOverlay'); if(ov) ov.classList.remove('show'); renderHistory(); nav('#screenHistory'); });

    // Laufenden Timer wiederherstellen
    if(st.running){ renderTimerUI(); } else { nav('#screenStart'); }

    // Haptik
    document.addEventListener('click',function(e){ if(e.target && e.target.closest && e.target.closest('button')) vib(5); }, {passive:true});

    // Quick-Start via URL (?quick=30 / 60)
    try{
      var params=new URLSearchParams(location.search); var qmin=parseInt(params.get('quick')||''); if(qmin>0){ startFlow(qmin); }
    }catch(_){}

  }catch(err){
    console.error('Boot-Fehler:',err);
    toast('Fehler beim Start (Konsole prüfen)');
  }
}
function highlightAlarmSelection(){ $$('.alarm-select').forEach(function(b){ var t=parseInt(b.dataset.type,10)||2; b.classList.toggle('primary',t===cfg.alarmType); b.classList.toggle('flat',t!==cfg.alarmType); }); }

/* ===== Flow: Standort -> Foto -> Start ===== */
async function startFlow(minutes){
  if(flowLock) return; flowLock=true;
  try{
    nav('#screenTimer'); // Zielseite zuerst zeigen
    var wantLoc=await showPrompt('Standort speichern?','So findest du den Platz direkt auf der Karte.'); if(wantLoc){ await askGeo(); showMapBtn(); }
    var wantPhoto=await showPrompt('Foto vom Parkplatz machen?','Hilft dir, dein Auto schneller wiederzufinden.');
    if(wantPhoto){ var w=$('#photoWrap'); if(w) w.style.display='block'; await startCam(); await waitForPhotoDecision(); stopCam(); } else { st.photo=null; saveState(); renderPhoto(); }
    startTimer(minutes);
  } finally { flowLock=false; }
}

/* ===== Init: DOMContentLoaded & Service Worker ===== */
document.addEventListener('DOMContentLoaded', function(){ boot(); setupA2HS(); registerSW(); });

})();
</script>
</body>
</html>
